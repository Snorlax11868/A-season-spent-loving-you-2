<html>
<body>
  <h1>A Season Spent Loving You</h1>
  <div id="progress"></div>

  <div id="page-selector">
    Jump to page:
    <select id="page-select"></select>
  </div>

  <div style="text-align: center; margin-bottom: 10px;">
    <input id="search" type="text" placeholder="Search story..." />
    <button onclick="searchText()">ğŸ”</button>
  </div>

  <div style="text-align: center; margin-bottom: 10px;">
    <label>Text size:
      <input id="font-size" type="range" min="14" max="24" step="1" value="18">
    </label>
    <button id="toggle-font">Toggle Font</button>
    <button id="dark-mode-toggle">ğŸŒ“</button>
  </div>

  <div id="story-container">Loading story...</div>

  <button id="back">&larr; Back</button>
  <button id="continue">Continue &rarr;</button>

  <div id="music-player">
    <div id="now-playing">Now Playing: <span id="current-song">None</span></div>
    <audio id="audio" controls autoplay></audio>
    <div id="playlist"></div>
  </div>

  <button id="mute-btn">ğŸ”Š</button>

  <script>
    const docUrl = "https://docs.google.com/document/d/e/2PACX-1vTqZBPA3iIzbIUmz-NTlIRPVxPzbh3QhcrmsyFGOBnjMmVymXiEJIkkViykoKdJag69HVtM8P4t36zW/pub";
    const container = document.getElementById('story-container');
    const button = document.getElementById('continue');
    const backButton = document.getElementById('back');
    const pageSelect = document.getElementById('page-select');
    const fontSizeSlider = document.getElementById('font-size');
    const toggleFont = document.getElementById('toggle-font');
    const darkToggle = document.getElementById('dark-mode-toggle');

    let pages = [];
    let currentPage = 0;
    let currentFont = "Georgia, serif";

    fetch(docUrl)
      .then(res => res.text())
      .then(data => {
        const parser = new DOMParser();
        const htmlDoc = parser.parseFromString(data, 'text/html');
        let text = htmlDoc.body.innerText;
        text = text.replace(/^Published using Google Docs\s*/, '').replace(/[\u200B-\u200D\uFEFF]/g, '');
        pages = text.includes("===PAGE===") ? text.split("===PAGE===") : [text];
        while (pages.length && pages[pages.length - 1].trim() === "") pages.pop();

        pages.forEach((_, i) => {
          const option = document.createElement("option");
          option.value = i;
          option.textContent = `Page ${i + 1}`;
          pageSelect.appendChild(option);
        });

        const savedPage = parseInt(localStorage.getItem("lastPage"));
        if (!isNaN(savedPage) && savedPage >= 0 && savedPage < pages.length) currentPage = savedPage;

        const savedTrack = parseInt(localStorage.getItem("currentTrack"));
        if (!isNaN(savedTrack)) currentTrack = savedTrack;

        pageSelect.value = currentPage;
        showPage();
        loadSong(currentTrack);
      })
      .catch(err => {
        container.innerText = "Failed to load story.";
        console.error(err);
      });

    function showPage() {
      while (pages[currentPage] && pages[currentPage].trim() === "" && currentPage < pages.length - 1) currentPage++;
      container.classList.remove("visible");

      setTimeout(() => {
        container.innerText = pages[currentPage].trim();
        container.classList.add("visible");
        button.style.display = (currentPage < pages.length - 1) ? "block" : "none";
        backButton.style.display = (currentPage > 0) ? "block" : "none";
        document.getElementById("progress").innerText = `Page ${currentPage + 1} of ${pages.length}`;
        pageSelect.value = currentPage;
        localStorage.setItem("lastPage", currentPage);
      }, 100);
    }

    button.addEventListener('click', () => {
      if (currentPage < pages.length - 1) currentPage++;
      showPage();
    });

    backButton.addEventListener('click', () => {
      if (currentPage > 0) currentPage--;
      showPage();
    });

    pageSelect.addEventListener('change', () => {
      currentPage = parseInt(pageSelect.value);
      showPage();
    });

    document.addEventListener("keydown", e => {
      if (e.key === "ArrowRight" && currentPage < pages.length - 1) {
        currentPage++;
        showPage();
      } else if (e.key === "ArrowLeft" && currentPage > 0) {
        currentPage--;
        showPage();
      }
    });

    // Search
    function searchText() {
      const term = document.getElementById("search").value.toLowerCase();
      if (!term) return;
      const index = pages.findIndex(p => p.toLowerCase().includes(term));
      if (index !== -1) {
        currentPage = index;
        showPage();
      } else {
        alert("No matches found.");
      }
    }

    // Font size adjuster
    fontSizeSlider.addEventListener("input", () => {
      container.style.fontSize = `${fontSizeSlider.value}px`;
    });

    // Font toggle
    toggleFont.addEventListener("click", () => {
      currentFont = currentFont.includes("Georgia") ? "Arial, sans-serif" : "Georgia, serif";
      container.style.fontFamily = currentFont;
    });

    // Dark mode toggle
    darkToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
    });

    // Music
    const playlist = [
      { title: "Let You Break My Heart Again", src: "Music/let_you_break_my_heart_again.mp3" },
      { title: "Mia and Sebastianâ€™s Theme", src: "Music/hauser_mia_and_sebastian_theme.mp3" },
      { title: "Merry Go Round of Life", src: "Music/merry_go_round_of_life.mp3" }
    ];
    const audio = document.getElementById('audio');
    const currentSong = document.getElementById('current-song');
    const playlistDiv = document.getElementById('playlist');
    const muteBtn = document.getElementById('mute-btn');
    let currentTrack = 0;
    let isMuted = false;

    function loadSong(index) {
      audio.src = playlist[index].src;
      currentSong.textContent = playlist[index].title;
      localStorage.setItem("currentTrack", index);
      audio.play().catch(e => console.log("Autoplay blocked"));
    }

    audio.addEventListener('ended', () => {
      currentTrack = (currentTrack + 1) % playlist.length;
      loadSong(currentTrack);
    });

    playlist.forEach((song, index) => {
      const btn = document.createElement('button');
      btn.textContent = song.title;
      btn.onclick = () => {
        currentTrack = index;
        loadSong(currentTrack);
      };
      playlistDiv.appendChild(btn);
    });

    muteBtn.addEventListener('click', () => {
      isMuted = !isMuted;
      audio.muted = isMuted;
      muteBtn.innerText = isMuted ? "ğŸ”‡" : "ğŸ”Š";
    });

    window.addEventListener("load", () => {
      const savedTrack = parseInt(localStorage.getItem("currentTrack"));
      if (!isNaN(savedTrack)) currentTrack = savedTrack;
      loadSong(currentTrack);
    });
  </script>

  <style>
    body.dark-mode {
      background-color: #111;
      color: #eee;
    }
    body.dark-mode #story-container {
      background: #1c1c1c;
      color: #eee;
    }
    body.dark-mode #now-playing {
      color: #bbb;
    }
  </style>
</body>
</html>
