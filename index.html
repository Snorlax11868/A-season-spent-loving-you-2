<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>A Season Spent Loving You</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Great+Vibes&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin:0; padding:0;
      font-family:'Playfair Display', serif;
      background:#f9f6f3; color:#111;
      overflow-x:hidden; transition: background .5s, color .5s;
      height:100vh; position:relative;
    }
    body.dark-mode {
      background:#1a1a1d; color:#eaeaea;
    }
    body::before {
      content: ""; position:fixed;
      top:0; left:0; right:0; bottom:0;
      background: url('https://upload.wikimedia.org/wikipedia/commons/0/0e/Epiphyllum_oxypetalum_%28flower%29.jpg') center/cover no-repeat fixed;
      opacity:.05; z-index:-1;
      transition: opacity .5s;
    }
    body.dark-mode::before {
      background: radial-gradient(ellipse at center, rgba(168,69,101,.1) 0%, rgba(26,26,29,1) 100%);
    }

    h1 {
      font-family:'Great Vibes', cursive;
      text-align:center; margin:20px 0; font-size:2.8em;
      color:#a84565; opacity:0; animation: fadeInTitle .8s forwards;
    }
    @keyframes fadeInTitle {
      from { opacity:0; transform:translateY(-10px); }
      to { opacity:1; transform:translateY(0); }
    }
    .tagline {
      text-align:center; font-style:italic;
      color:#888; margin-bottom:10px;
    }

    #story-container {
      max-width:700px; margin:20px auto;
      padding:20px;
      background:#fff; color:#111;
      border-radius:8px; box-shadow:0 0 8px rgba(0,0,0,.1);
      min-height:250px; opacity:0;
    }
    body.dark-mode #story-container {
      background:#2e2e2e; color:#eaeaea;
    }

    .special-title {
      font-family:'Great Vibes', cursive;
      font-size:2em; text-align:center;
      margin-bottom:10px; opacity:0;
    }

    #controls, #progress {
      text-align:center; margin:10px;
    }
    button, select {
      margin:4px; padding:8px 14px;
      cursor:pointer; font-size:1em;
    }

    #music-player {
      position:fixed; bottom:20px; left:50%;
      transform:translateX(-50%);
      background:rgba(255,255,255,.8);
      padding:10px; border-radius:20px;
      backdrop-filter:blur(5px);
    }
    body.dark-mode #music-player {
      background:rgba(40,40,42,.8);
    }

    #visualizer { width:200px; height:40px; background:#222; border-radius:4px; margin:10px auto; display:flex; overflow:hidden; }
    .bar { flex:1; margin:0 1px; background:#a84565; animation: bar 0s infinite; }
    @keyframes bar { from {height:5px;} to {height:35px;} }

    #playlist button { margin:2px; padding:6px; font-size:.9em; background:#eee; }
    body.dark-mode #playlist button { background:#444; color:#fff; }
  </style>
</head>
<body class="light-mode">

  <h1>A Season Spent Loving You</h1>
  <div class="tagline">Letters written when the world was asleep</div>

  <div id="progress"></div>
  <div id="page-selector">Jump to: <select id="page-select"></select></div>

  <div id="story-container"></div>

  <div id="controls">
    <button id="back">‚Üê Back</button>
    <button id="continue">Continue ‚Üí</button>
    <button id="font-toggle">Font</button>
    <button id="text-size-smaller">A‚àí</button>
    <button id="text-size-larger">A+</button>
    <button id="dark-mode-toggle">üåô</button>
  </div>

  <div id="music-player">
    <div id="visualizer"></div>
    üéµ Now Playing: <span id="current-song">None</span><br>
    <audio id="audio"></audio>
    <div id="playlist"></div>
  </div>

  <script>
    // Fetch & handle pages‚Ä¶
    const url = "https://docs.google.com/document/d/e/2PACX-1vTqZBPA3iIzbIUmz-NTlIRPVxPzbh3QhcrmsyFGOBnjMmVymXiEJIkkViykoKdJag69HVtM8P4t36zW/pub";
    const out = document.getElementById("story-container"),
          next = document.getElementById("continue"),
          back = document.getElementById("back"),
          select = document.getElementById("page-select"),
          progress = document.getElementById("progress");
    let pages=[], page=0, speed=20;

    const special={19:"Carpe‚ÄØDiem",43:"Mi‚ÄØcielo",44:"The‚ÄØThought‚ÄØof‚ÄØYou"};

    fetch(url).then(r=>r.text()).then(t=>{
      const doc = new DOMParser().parseFromString(t,"text/html");
      let text=doc.body.innerText.replace(/^Published.*/,"").replace(/[\u200B-\uFEFF]/g,"");
      pages = text.split("===PAGE===").map(p=>p.trim()).filter(p=>p);
      pages.forEach((_,i)=>{
        const o=new Option(`Page ${i+1}`,i); select.add(o);
      });
      page = parseInt(localStorage.getItem("last"))||0;
      select.value=page; show();
    });

    function show(){
      out.innerHTML="";
      const title = special[page];
      if(title){
        const t=document.createElement("div");
        t.className="special-title"; out.append(t);
      }
      const c=document.createElement("div");
      out.append(c);
      typeWriter(title? title+"\n\n"+pages[page] : pages[page], out.children[out.children.length-1], ()=>{
        out.style.opacity=1;
      });
      progress.textContent=`Page ${page+1} of ${pages.length}`;
      select.value=page;
      back.style.display=page? "inline":"none";
      next.style.display=page<pages.length-1? "inline":"none";
      localStorage.setItem("last",page);
    }

    function typeWriter(txt, el, cb){
      let i=0, interval=setInterval(()=>{
        el.textContent+=txt.charAt(i++);
        if(i>=txt.length){ clearInterval(interval); cb(); }
      }, speed);
    }

    next.onclick=()=>{ if(page<pages.length-1) page++; out.style.opacity=0; show(); };
    back.onclick=()=>{ if(page>0) page--; out.style.opacity=0; show(); };
    select.onchange=()=>{ page=+select.value; out.style.opacity=0; show(); };
    document.addEventListener("keydown",e=>{
      if(e.key==="ArrowRight") next.click();
      if(e.key==="ArrowLeft") back.click();
    });

    document.getElementById("font-toggle").onclick=()=>{
      out.style.fontFamily = out.style.fontFamily.includes("sans")? "'Playfair Display', serif":"Arial, sans-serif";
    };
    document.getElementById("text-size-smaller").onclick=()=>{
      let sz=parseFloat(getComputedStyle(out).fontSize); out.style.fontSize = Math.max(sz-1,12)+"px";
    };
    document.getElementById("text-size-larger").onclick=()=>{
      let sz=parseFloat(getComputedStyle(out).fontSize); out.style.fontSize = (sz+1)+"px";
    };
    document.getElementById("dark-mode-toggle").onclick=()=>{
      document.body.classList.toggle("dark-mode");
      document.body.classList.toggle("light-mode");
    };

    // Music + visualizer
    const pls=[
      {title:"Let You Break My Heart Again", src:"Music/let_you_break_my_heart_again.mp3"},
      {title:"Mia and Sebastian‚Äôs Theme", src:"Music/hauser_mia_and_sebastian_theme.mp3"},
      {title:"Merry Go Round of Life", src:"Music/merry_go_round_of_life.mp3"}
    ];
    const audio=document.getElementById("audio"),
          now=document.getElementById("current-song"),
          pv=document.getElementById("playlist"),
          viz=document.getElementById("visualizer");
    let track=parseInt(localStorage.getItem("track"))||0;

    pls.forEach((s,i)=>{
      const b=document.createElement("button");
      b.textContent=s.title; b.onclick=()=>{ play(i); }; pv.append(b);
    });

    document.addEventListener("DOMContentLoaded",()=>play(track));

    function play(i){
      track=i; localStorage.setItem("track",i);
      audio.src=pls[i].src; now.textContent=pls[i].title;
      audio.play().catch(()=>{});
      animateBars();
    }
    audio.onended=()=>play((track+1)%pls.length);

    function animateBars(){
      viz.innerHTML="";
      for(let i=0;i<20;i++){
        const bar=document.createElement("div");
        bar.className="bar";
        bar.style.animationDuration=(Math.random()*0.2+0.1)+"s";
        bar.style.animationDelay=(Math.random()*0.2)+"s";
        viz.append(bar);
      }
    }
  </script>
</body>
</html>
